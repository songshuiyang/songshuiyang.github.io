<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>SpringBoot(七)内嵌Tomcat启动原理解析 | 宋水阳个人博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Spring,Spring Boot">
    <meta name="description" content="前言 我们知道在使用Spring Boot项目的时候可以不用依赖外部Tomcat就可以启动，那么Spring Boot是怎么做到的呢？其实就是只需要引入spring-boot-starter-web，在应用启动时会自动启动嵌入版的tomcat作为应用服务器，下面我们来学习下其实现原理。  解析TomcatEmbeddedServletContainerFactory 自动配置 嵌入版的tomcat">
<meta name="keywords" content="Spring,Spring Boot">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringBoot(七)内嵌Tomcat启动原理解析">
<meta property="og:url" content="http://www.songshuiyang.com/2019/08/06/backend/framework/spring/spring-boot/analysis/SpringBoot(七)内嵌Tomcat启动原理解析/index.html">
<meta property="og:site_name" content="宋水阳个人博客">
<meta property="og:description" content="前言 我们知道在使用Spring Boot项目的时候可以不用依赖外部Tomcat就可以启动，那么Spring Boot是怎么做到的呢？其实就是只需要引入spring-boot-starter-web，在应用启动时会自动启动嵌入版的tomcat作为应用服务器，下面我们来学习下其实现原理。  解析TomcatEmbeddedServletContainerFactory 自动配置 嵌入版的tomcat">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://www.songshuiyang.com/images/server/spring/spring-boot/TomcatEmbeddedServletContainerFactory.png">
<meta property="og:image" content="http://www.songshuiyang.com/images/server/spring/spring-boot/EmbeddedServletContainer.png">
<meta property="og:image" content="http://www.songshuiyang.com/images/server/spring/spring-boot/tomcat1.png">
<meta property="og:image" content="http://www.songshuiyang.com/images/server/spring/spring-boot/tomcat2.png">
<meta property="og:updated_time" content="2019-09-16T13:11:05.531Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SpringBoot(七)内嵌Tomcat启动原理解析">
<meta name="twitter:description" content="前言 我们知道在使用Spring Boot项目的时候可以不用依赖外部Tomcat就可以启动，那么Spring Boot是怎么做到的呢？其实就是只需要引入spring-boot-starter-web，在应用启动时会自动启动嵌入版的tomcat作为应用服务器，下面我们来学习下其实现原理。  解析TomcatEmbeddedServletContainerFactory 自动配置 嵌入版的tomcat">
<meta name="twitter:image" content="http://www.songshuiyang.com/images/server/spring/spring-boot/TomcatEmbeddedServletContainerFactory.png">
    
        <link rel="alternate" type="application/atom+xml" title="宋水阳个人博客" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.png">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">songshuiyang</h5>
          <a href="mailto:songshuiyang@foxmail.com" title="songshuiyang@foxmail.com" class="mail">songshuiyang@foxmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/">
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives">
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories">
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags">
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags/Java基础">
                <i class="icon icon-lg icon-bookmark"></i>
                Java基础
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags/Java集合">
                <i class="icon icon-lg icon-camera"></i>
                Java集合
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags/Java并发">
                <i class="icon icon-lg icon-fire"></i>
                Java并发
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags/Io">
                <i class="icon icon-lg icon-film"></i>
                Java IO
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/JVM">
                <i class="icon icon-lg icon-gift"></i>
                JVM
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/Spring">
                <i class="icon icon-lg icon-money"></i>
                Spring
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/SpringMvc">
                <i class="icon icon-lg icon-bullhorn"></i>
                SpringMvc
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/SpringBoot">
                <i class="icon icon-lg icon-bolt"></i>
                SpringBoot
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/SpringCloud">
                <i class="icon icon-lg icon-cogs"></i>
                SpringCloud
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/Mybatis">
                <i class="icon icon-lg icon-tasks"></i>
                Mybatis
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/设计模式">
                <i class="icon icon-lg icon-calendar"></i>
                设计模式
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/数据库">
                <i class="icon icon-lg icon-compass"></i>
                数据库
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/缓存">
                <i class="icon icon-lg icon-comment"></i>
                缓存
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/消息队列">
                <i class="icon icon-lg icon-coffee"></i>
                消息队列
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/分布式">
                <i class="icon icon-lg icon-code"></i>
                分布式
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/计算机网络">
                <i class="icon icon-lg icon-umbrella"></i>
                计算机网络
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/数据结构">
                <i class="icon icon-lg icon-spinner"></i>
                数据结构
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/Linux">
                <i class="icon icon-lg icon-magic"></i>
                Linux
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/前端">
                <i class="icon icon-lg icon-twitter"></i>
                前端
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/笔记">
                <i class="icon icon-lg icon-bell"></i>
                笔记
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/开发工具">
                <i class="icon icon-lg icon-strikethrough"></i>
                开发工具
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories/业务">
                <i class="icon icon-lg icon-pinterest"></i>
                业务
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/songshuiyang" target="_blank">
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ac93934d9b847216e10a2f133187e535";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>
<header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">SpringBoot(七)内嵌Tomcat启动原理解析</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">SpringBoot(七)内嵌Tomcat启动原理解析</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-08-05T16:07:00.000Z" itemprop="datePublished" class="page-time">
  2019-08-06
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/SpringBoot/">SpringBoot</a></li></ul>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#前言"><span class="post-toc-number">1.</span> <span class="post-toc-text">前言</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#解析"><span class="post-toc-number">2.</span> <span class="post-toc-text">解析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#TomcatEmbeddedServletContainerFactory-自动配置"><span class="post-toc-number">2.0.1.</span> <span class="post-toc-text">TomcatEmbeddedServletContainerFactory 自动配置</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#TomcatEmbeddedServletContainer-创建"><span class="post-toc-number">2.0.2.</span> <span class="post-toc-text">TomcatEmbeddedServletContainer 创建</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#TomcatEmbeddedServletContainer-使用"><span class="post-toc-number">2.0.3.</span> <span class="post-toc-text">TomcatEmbeddedServletContainer 使用</span></a></li></ol></li></ol><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#其他"><span class="post-toc-number">3.</span> <span class="post-toc-text">其他</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#总结"><span class="post-toc-number">4.</span> <span class="post-toc-text">总结</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#参考"><span class="post-toc-number">5.</span> <span class="post-toc-text">参考</span></a></li>
        </nav>
    </aside>


<article id="post-backend/framework/spring/spring-boot/analysis/SpringBoot(七)内嵌Tomcat启动原理解析" class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">SpringBoot(七)内嵌Tomcat启动原理解析</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-08-06 00:07:00" datetime="2019-08-05T16:07:00.000Z" itemprop="datePublished">2019-08-06</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/SpringBoot/">SpringBoot</a></li></ul>



            

<span id="busuanzi_container_site_pv">
   <i class="icon icon-eye icon-pr"></i>本页总访问量<span id="busuanzi_value_page_pv"></span>次
</span>



        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><ul>
<li>我们知道在使用<code>Spring Boot</code>项目的时候可以不用依赖外部<code>Tomcat</code>就可以启动，那么<code>Spring Boot</code>是怎么做到的呢？其实就是只需要引入<code>spring-boot-starter-web</code>，在应用启动时会自动启动嵌入版的<code>tomcat</code>作为应用服务器，下面我们来学习下其实现原理。</li>
</ul>
<h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><h4 id="TomcatEmbeddedServletContainerFactory-自动配置"><a href="#TomcatEmbeddedServletContainerFactory-自动配置" class="headerlink" title="TomcatEmbeddedServletContainerFactory 自动配置"></a>TomcatEmbeddedServletContainerFactory 自动配置</h4><ul>
<li><p>嵌入版的<code>tomcat</code>起作用的关键是<code>TomcatEmbeddedServletContainerFactory</code>，下面将讲解该类的注册</p>
</li>
<li><p>第四章节已经介绍了自动配置的实现，查看<code>spring-boot-autoconfigure</code>模块的<code>META-INF/spring.factories</code>文件，关注<code>EmbeddedServletContainerAutoConfiguration</code>这个配置类，看类名可以翻译为嵌入式的<code>Servlet</code>容器自动配置类，所以以后如果想知道其他功能是怎么被集成进来的，可以在<code>spring.factories</code>中找找对应的自动配置类</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\</span><br><span class="line">... </span><br><span class="line">org.springframework.boot.autoconfigure.web.EmbeddedServletContainerAutoConfiguration,\</span><br><span class="line">...</span><br><span class="line">org.springframework.boot.autoconfigure.webservices.WebServicesAutoConfiguration</span><br></pre></td></tr></table></figure>
<ul>
<li>进入<code>EmbeddedServletContainerAutoConfiguration.java</code>，可以看到使用不同的<code>@Conditional</code>注解可以针对不同的环境情况选择注册不同的<code>Bean</code>，下面根据条件会注册不同的<code>Servlet</code>容器<ul>
<li>注册<code>Tomcat</code>容器工厂</li>
<li>注册<code>Jetty</code>容器工厂</li>
<li>注册<code>Undertow</code>容器工厂</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 嵌入式的`Servlet`容器自动配置类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> EnableAutoConfiguration Auto-configuration&#125; for an embedded servlet containers.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ivan Sopov</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Stephane Nicoll</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@AutoConfigureOrder</span>(Ordered.HIGHEST_PRECEDENCE)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication</span> <span class="comment">// 注解表明只有在web环境下才会创建容器相关信息，因此应用无需容器则使用</span></span><br><span class="line"><span class="meta">@Import</span>(BeanPostProcessorsRegistrar.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbeddedServletContainerAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 注册Tomcat容器工厂</span></span><br><span class="line"><span class="comment">	 * 由于存在<span class="doctag">@ConditionalOnMissingBean</span>注解，因此优先使用用户自定义的EmbeddedServletContainerFactory</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Nested configuration if Tomcat is being used.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Configuration</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass</span>(&#123; Servlet.class, Tomcat.class &#125;)</span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(value = EmbeddedServletContainerFactory.class, search = SearchStrategy.CURRENT)</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbeddedTomcat</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> TomcatEmbeddedServletContainerFactory <span class="title">tomcatEmbeddedServletContainerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> TomcatEmbeddedServletContainerFactory();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 注册Jetty容器工厂</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Nested configuration if Jetty is being used.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Configuration</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass</span>(&#123; Servlet.class, Server.class, Loader.class,</span><br><span class="line">			WebAppContext.class &#125;)</span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(value = EmbeddedServletContainerFactory.class, search = SearchStrategy.CURRENT)</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbeddedJetty</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> JettyEmbeddedServletContainerFactory <span class="title">jettyEmbeddedServletContainerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> JettyEmbeddedServletContainerFactory();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 注册Undertow容器工厂</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Nested configuration if Undertow is being used.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Configuration</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass</span>(&#123; Servlet.class, Undertow.class, SslClientAuthMode.class &#125;)</span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(value = EmbeddedServletContainerFactory.class, search = SearchStrategy.CURRENT)</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbeddedUndertow</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> UndertowEmbeddedServletContainerFactory <span class="title">undertowEmbeddedServletContainerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> UndertowEmbeddedServletContainerFactory();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Registers a &#123;<span class="doctag">@link</span> EmbeddedServletContainerCustomizerBeanPostProcessor&#125;. Registered</span></span><br><span class="line"><span class="comment">	 * via &#123;<span class="doctag">@link</span> ImportBeanDefinitionRegistrar&#125; for early registration.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanPostProcessorsRegistrar</span></span></span><br><span class="line"><span class="class">			<span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">BeanFactoryAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> ConfigurableListableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> ConfigurableListableBeanFactory) &#123;</span><br><span class="line">				<span class="keyword">this</span>.beanFactory = (ConfigurableListableBeanFactory) beanFactory;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata,</span></span></span><br><span class="line"><span class="function"><span class="params">				BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.beanFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			registerSyntheticBeanIfMissing(registry,</span><br><span class="line">					<span class="string">"embeddedServletContainerCustomizerBeanPostProcessor"</span>,</span><br><span class="line">					EmbeddedServletContainerCustomizerBeanPostProcessor.class);</span><br><span class="line">			registerSyntheticBeanIfMissing(registry,</span><br><span class="line">					<span class="string">"errorPageRegistrarBeanPostProcessor"</span>,</span><br><span class="line">					ErrorPageRegistrarBeanPostProcessor.class);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerSyntheticBeanIfMissing</span><span class="params">(BeanDefinitionRegistry registry,</span></span></span><br><span class="line"><span class="function"><span class="params">				String name, Class&lt;?&gt; beanClass)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (ObjectUtils.isEmpty(</span><br><span class="line">					<span class="keyword">this</span>.beanFactory.getBeanNamesForType(beanClass, <span class="keyword">true</span>, <span class="keyword">false</span>))) &#123;</span><br><span class="line">				RootBeanDefinition beanDefinition = <span class="keyword">new</span> RootBeanDefinition(beanClass);</span><br><span class="line">				beanDefinition.setSynthetic(<span class="keyword">true</span>);</span><br><span class="line">				registry.registerBeanDefinition(name, beanDefinition);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>我们这里关注<code>TomcatEmbeddedServletContainerFactory</code>类，下面是类继承关系图：</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/images/server/spring/spring-boot/TomcatEmbeddedServletContainerFactory.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<ul>
<li><code>TomcatEmbeddedServletContainerFactory</code>类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TomcatEmbeddedServletContainerFactory</span> <span class="keyword">extends</span> <span class="title">AbstractEmbeddedServletContainerFactory</span> <span class="keyword">implements</span> <span class="title">ResourceLoaderAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Charset DEFAULT_CHARSET = Charset.forName(<span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;Class&lt;?&gt;&gt; NO_CLASSES = Collections.emptySet();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The class name of default protocol used.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_PROTOCOL = <span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> File baseDirectory;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;Valve&gt; engineValves = <span class="keyword">new</span> ArrayList&lt;Valve&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;Valve&gt; contextValves = <span class="keyword">new</span> ArrayList&lt;Valve&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;LifecycleListener&gt; contextLifecycleListeners = <span class="keyword">new</span> ArrayList&lt;LifecycleListener&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;TomcatContextCustomizer&gt; tomcatContextCustomizers = <span class="keyword">new</span> ArrayList&lt;TomcatContextCustomizer&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;TomcatConnectorCustomizer&gt; tomcatConnectorCustomizers = <span class="keyword">new</span> ArrayList&lt;TomcatConnectorCustomizer&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;Connector&gt; additionalTomcatConnectors = <span class="keyword">new</span> ArrayList&lt;Connector&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String protocol = DEFAULT_PROTOCOL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Set&lt;String&gt; tldSkipPatterns = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;(</span><br><span class="line">			TldSkipPatterns.DEFAULT);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Charset uriEncoding = DEFAULT_CHARSET;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> backgroundProcessorDelay;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new &#123;<span class="doctag">@link</span> TomcatEmbeddedServletContainerFactory&#125; instance.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">TomcatEmbeddedServletContainerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new &#123;<span class="doctag">@link</span> TomcatEmbeddedServletContainerFactory&#125; that listens for</span></span><br><span class="line"><span class="comment">	 * requests using the specified port.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> port the port to listen on</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">TomcatEmbeddedServletContainerFactory</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(port);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new &#123;<span class="doctag">@link</span> TomcatEmbeddedServletContainerFactory&#125; with the specified</span></span><br><span class="line"><span class="comment">	 * context path and port.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> contextPath the root context path</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> port the port to listen on</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">TomcatEmbeddedServletContainerFactory</span><span class="params">(String contextPath, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(contextPath, port);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取EmbeddedServletContainer</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> initializers &#123;<span class="doctag">@link</span> ServletContextInitializer&#125;s that should be applied as</span></span><br><span class="line"><span class="comment">	 * the container starts</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> EmbeddedServletContainer <span class="title">getEmbeddedServletContainer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			ServletContextInitializer... initializers)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 构建Tomcat实例</span></span><br><span class="line">		Tomcat tomcat = <span class="keyword">new</span> Tomcat();</span><br><span class="line">		<span class="comment">// 配置Tomcat的基本环境</span></span><br><span class="line">		File baseDir = (<span class="keyword">this</span>.baseDirectory != <span class="keyword">null</span> ? <span class="keyword">this</span>.baseDirectory</span><br><span class="line">				: createTempDir(<span class="string">"tomcat"</span>));</span><br><span class="line">		tomcat.setBaseDir(baseDir.getAbsolutePath());</span><br><span class="line">		Connector connector = <span class="keyword">new</span> Connector(<span class="keyword">this</span>.protocol);</span><br><span class="line">		tomcat.getService().addConnector(connector);</span><br><span class="line">		customizeConnector(connector);</span><br><span class="line">		tomcat.setConnector(connector);</span><br><span class="line">		tomcat.getHost().setAutoDeploy(<span class="keyword">false</span>);</span><br><span class="line">		configureEngine(tomcat.getEngine());</span><br><span class="line">		<span class="keyword">for</span> (Connector additionalConnector : <span class="keyword">this</span>.additionalTomcatConnectors) &#123;</span><br><span class="line">			tomcat.getService().addConnector(additionalConnector);</span><br><span class="line">		&#125;</span><br><span class="line">		prepareContext(tomcat.getHost(), initializers);</span><br><span class="line">		<span class="comment">// 将配置好的Tomcat传入进去。返回一个EmbeddedServletContainer 并且启动tomcat容器</span></span><br><span class="line">		<span class="keyword">return</span> getTomcatEmbeddedServletContainer(tomcat);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>TomcatEmbeddedServletContainerFactory</code>类，这个类是创建<code>Tomcat</code>容器的工厂类，可以看到这个类实现了<code>EmbeddedServletContainerFactory</code>接口</p>
<ul>
<li><p>查看<code>EmbeddedServletContainerFactory</code>接口，该接口只有一个方法，该方法用于获取<code>Servlet</code>容器（<code>EmbeddedServletContainer</code>）</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmbeddedServletContainerFactory</span> </span>&#123;</span><br><span class="line">    <span class="function">EmbeddedServletContainer <span class="title">getEmbeddedServletContainer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            ServletContextInitializer... initializers)</span></span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>TomcatEmbeddedServletContainerFactory</code>类实现了<code>getEmbeddedServletContainer()</code>方法，可以看到<code>Tomcat tomcat = new Tomcat()</code>是创建了一个汤姆猫，然后构造为<code>EmbeddedServletContainer</code>对象</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取EmbeddedServletContainer</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> initializers &#123;<span class="doctag">@link</span> ServletContextInitializer&#125;s that should be applied as</span></span><br><span class="line"><span class="comment"> * the container starts</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> EmbeddedServletContainer <span class="title">getEmbeddedServletContainer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ServletContextInitializer... initializers)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 构建Tomcat实例</span></span><br><span class="line">    Tomcat tomcat = <span class="keyword">new</span> Tomcat();</span><br><span class="line">    <span class="comment">// 配置Tomcat的基本环境</span></span><br><span class="line">    File baseDir = (<span class="keyword">this</span>.baseDirectory != <span class="keyword">null</span> ? <span class="keyword">this</span>.baseDirectory</span><br><span class="line">            : createTempDir(<span class="string">"tomcat"</span>));</span><br><span class="line">    tomcat.setBaseDir(baseDir.getAbsolutePath());</span><br><span class="line">    Connector connector = <span class="keyword">new</span> Connector(<span class="keyword">this</span>.protocol);</span><br><span class="line">    tomcat.getService().addConnector(connector);</span><br><span class="line">    customizeConnector(connector);</span><br><span class="line">    tomcat.setConnector(connector);</span><br><span class="line">    tomcat.getHost().setAutoDeploy(<span class="keyword">false</span>);</span><br><span class="line">    configureEngine(tomcat.getEngine());</span><br><span class="line">    <span class="keyword">for</span> (Connector additionalConnector : <span class="keyword">this</span>.additionalTomcatConnectors) &#123;</span><br><span class="line">        tomcat.getService().addConnector(additionalConnector);</span><br><span class="line">    &#125;</span><br><span class="line">    prepareContext(tomcat.getHost(), initializers);</span><br><span class="line">    <span class="comment">// 将配置好的Tomcat传入进去。返回一个EmbeddedServletContainer 并且启动tomcat容器</span></span><br><span class="line">    <span class="keyword">return</span> getTomcatEmbeddedServletContainer(tomcat);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看<code>EmbeddedServletContainer</code>接口，该接口是<code>Servlet</code>容器的抽象，可以看到有三个方法，<code>start()</code> <code>stop()</code> <code>getPort();</code></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmbeddedServletContainer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动容器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Starts the embedded servlet container. Calling this method on an already started</span></span><br><span class="line"><span class="comment">     * container has no effect.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> EmbeddedServletContainerException if the container cannot be started</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> EmbeddedServletContainerException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 停止容器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Stops the embedded servlet container. Calling this method on an already stopped</span></span><br><span class="line"><span class="comment">     * container has no effect.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> EmbeddedServletContainerException if the container cannot be stopped</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> <span class="keyword">throws</span> EmbeddedServletContainerException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取服务端口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Return the port this server is listening on.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the port (or -1 if none)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPort</span><span class="params">()</span></span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>下图是显示了<code>Spring Boot</code>定义了哪些容器</p>
<ul>
<li><code>UndertowEmbeddedServletContainer</code> (org.springframework.boot.context.embedded.undertow)</li>
<li><code>MockEmbeddedServletContainer</code> (org.springframework.boot.context.embedded)</li>
<li><code>TomcatEmbeddedServletContainer</code> (org.springframework.boot.context.embedded.tomcat)</li>
<li><code>JettyEmbeddedServletContainer</code> (org.springframework.boot.context.embedded.jetty)</li>
</ul>
</li>
</ul>
</li>
<li><code>EmbeddedServletContainer.java</code></li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/images/server/spring/spring-boot/EmbeddedServletContainer.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<ul>
<li>到这里<code>TomcatEmbeddedServletContainerFactory</code>已经自动注册完成了，使用<code>@Conditional</code>相关注解可以控制只有在web环境下才会创建容器相关信息，有了容器的创建工厂之后就可以使用<code>Servlet</code>容器了<code>EmbeddedServletContainer</code></li>
</ul>
<h4 id="TomcatEmbeddedServletContainer-创建"><a href="#TomcatEmbeddedServletContainer-创建" class="headerlink" title="TomcatEmbeddedServletContainer 创建"></a>TomcatEmbeddedServletContainer 创建</h4><ul>
<li>由上面可以知道<code>TomcatEmbeddedServletContainer</code>的创建是由<code>TomcatEmbeddedServletContainerFactory</code>类的<code>getEmbeddedServletContainer()</code>方法来实现的，从下面<code>private final Tomcat tomcat;</code>可以看到我们的<code>Tomcat</code>猫</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TomcatEmbeddedServletContainer</span> <span class="keyword">implements</span> <span class="title">EmbeddedServletContainer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(TomcatEmbeddedServletContainer.class);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger containerCounter = <span class="keyword">new</span> AtomicInteger(-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Object monitor = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Service, Connector[]&gt; serviceConnectors = <span class="keyword">new</span> HashMap&lt;Service, Connector[]&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Tomcat猫</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Tomcat tomcat;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> autoStart;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> started;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new &#123;<span class="doctag">@link</span> TomcatEmbeddedServletContainer&#125; instance.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> tomcat the underlying Tomcat server</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">TomcatEmbeddedServletContainer</span><span class="params">(Tomcat tomcat)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>(tomcat, <span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new &#123;<span class="doctag">@link</span> TomcatEmbeddedServletContainer&#125; instance.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> tomcat the underlying Tomcat server</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> autoStart if the server should be started</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">TomcatEmbeddedServletContainer</span><span class="params">(Tomcat tomcat, <span class="keyword">boolean</span> autoStart)</span> </span>&#123;</span><br><span class="line">		Assert.notNull(tomcat, <span class="string">"Tomcat Server must not be null"</span>);</span><br><span class="line">		<span class="keyword">this</span>.tomcat = tomcat;</span><br><span class="line">		<span class="keyword">this</span>.autoStart = autoStart;</span><br><span class="line">		<span class="comment">// 启动容器</span></span><br><span class="line">		initialize();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> EmbeddedServletContainerException </span>&#123;</span><br><span class="line">		TomcatEmbeddedServletContainer.logger</span><br><span class="line">				.info(<span class="string">"Tomcat initialized with port(s): "</span> + getPortsDescription(<span class="keyword">false</span>));</span><br><span class="line">		<span class="keyword">synchronized</span> (<span class="keyword">this</span>.monitor) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				addInstanceIdToEngineName();</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="comment">// Remove service connectors to that protocol binding doesn't happen</span></span><br><span class="line">					<span class="comment">// yet</span></span><br><span class="line">					removeServiceConnectors();</span><br><span class="line"></span><br><span class="line">					<span class="comment">// Start the server to trigger initialization listeners</span></span><br><span class="line">					<span class="comment">// 启动 Tomcat</span></span><br><span class="line">					<span class="keyword">this</span>.tomcat.start();</span><br><span class="line"></span><br><span class="line">					<span class="comment">// We can re-throw failure exception directly in the main thread</span></span><br><span class="line">					rethrowDeferredStartupExceptions();</span><br><span class="line"></span><br><span class="line">					Context context = findContext();</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						ContextBindings.bindClassLoader(context, getNamingToken(context),</span><br><span class="line">								getClass().getClassLoader());</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">catch</span> (NamingException ex) &#123;</span><br><span class="line">						<span class="comment">// Naming is not enabled. Continue</span></span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="comment">// Unlike Jetty, all Tomcat threads are daemon threads. We create a</span></span><br><span class="line">					<span class="comment">// blocking non-daemon to stop immediate shutdown</span></span><br><span class="line">					startDaemonAwaitThread();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">					containerCounter.decrementAndGet();</span><br><span class="line">					<span class="keyword">throw</span> ex;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> EmbeddedServletContainerException(</span><br><span class="line">						<span class="string">"Unable to start embedded Tomcat"</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>
<h4 id="TomcatEmbeddedServletContainer-使用"><a href="#TomcatEmbeddedServletContainer-使用" class="headerlink" title="TomcatEmbeddedServletContainer 使用"></a>TomcatEmbeddedServletContainer 使用</h4><ul>
<li>有了<code>TomcatServletContainer</code>之后就需要启动了，那么<code>Spring Boot</code>是哪里触发调用的呢，可以在<code>TomcatEmbeddedServletContainer</code>的<code>initialize()</code>方法里打个断点</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/images/server/spring/spring-boot/tomcat1.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<ul>
<li>打好断点之后就是启动<code>Spring Boot</code>项目了，由下图可以看到是从<code>ApplicationContext</code>的<code>refresh()</code>开始触发的</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/images/server/spring/spring-boot/tomcat2.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<ul>
<li><p>现在我们从<code>main</code>方法开始一步步跟进</p>
<ul>
<li><p>1、<code>main</code>方法开始</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       SpringApplication.run(SampleTomcatJspApplication.class, args);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(Object[] sources, String[] args)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 创建 SpringApplication 对象，并执行运行。</span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> SpringApplication(sources).run(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>2、进入<code>org.springframework.boot.SpringApplication#run(java.lang.String...)</code>方法，由之前的第三章节可以知道这里我们的到的<code>ApplicationContext</code>实现类是<code>AnnotationConfigEmbeddedWebApplicationContext</code>，看名字可以知道这个类是基于注解配置的嵌入式Web应用容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//  创建 StopWatch 对象，并启动。StopWatch 主要用于简单统计 run 启动过程的时长。</span></span><br><span class="line">	StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">	stopWatch.start();</span><br><span class="line">	ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">	FailureAnalyzers analyzers = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">// 配置 headless 属性，这个逻辑，可以无视，和 AWT 相关。</span></span><br><span class="line">	configureHeadlessProperty();</span><br><span class="line">	<span class="comment">// 获得 SpringApplicationRunListener 的数组，并启动监听</span></span><br><span class="line">	SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">	listeners.starting();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// 创建  ApplicationArguments 对象</span></span><br><span class="line">		ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(args);</span><br><span class="line">		<span class="comment">// 加载属性配置。执行完成后，所有的 environment 的属性都会加载进来，包括 application.properties 和外部的属性配置。</span></span><br><span class="line">		ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments);</span><br><span class="line">		<span class="comment">// 打印 Spring Banner</span></span><br><span class="line">		Banner printedBanner = printBanner(environment);</span><br><span class="line">		<span class="comment">// 创建 Spring 容器。</span></span><br><span class="line">		context = createApplicationContext();</span><br><span class="line">		analyzers = <span class="keyword">new</span> FailureAnalyzers(context);</span><br><span class="line">		<span class="comment">// 主要是调用所有初始化类的 initialize 方法</span></span><br><span class="line">		prepareContext(context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">		<span class="comment">// 初始化 Spring 容器。</span></span><br><span class="line">		refreshContext(context);</span><br></pre></td></tr></table></figure>
</li>
<li><p>3、进入<code>refreshContext(context);</code>方法，下面可以看到是调用了<code>refresh(context);</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshContext</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 开启（刷新）Spring 容器</span></span><br><span class="line">	refresh(context);</span><br><span class="line">	<span class="comment">// 注册 ShutdownHook 钩子</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.registerShutdownHook) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			context.registerShutdownHook();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (AccessControlException ex) &#123;</span><br><span class="line">			<span class="comment">// Not allowed in some environments.</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>4、一直跳入可以发现进入到了<code>org.springframework.boot.context.embedded.EmbeddedWebApplicationContext#onRefresh</code>方法，<code>EmbeddedWebApplicationContext</code>重写了<code>onRefresh()</code>方法，在调父类<code>super.onRefresh();</code>方法之后又调用了<code>createEmbeddedServletContainer();</code>方法用于创建及启动容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.onRefresh();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// 创建及启动容器</span></span><br><span class="line">		createEmbeddedServletContainer();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Unable to start embedded container"</span>,</span><br><span class="line">				ex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>5、进入<code>createEmbeddedServletContainer()</code>方法可以看到通过<code>org.springframework.boot.context.embedded.EmbeddedServletContainerFactory#getEmbeddedServletContainer()</code>方法来创建了<code>EmbeddedServletContainer</code>，到现在就是和之前的内容联系起来了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createEmbeddedServletContainer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	EmbeddedServletContainer localContainer = <span class="keyword">this</span>.embeddedServletContainer;</span><br><span class="line">	ServletContext localServletContext = getServletContext();</span><br><span class="line">	<span class="keyword">if</span> (localContainer == <span class="keyword">null</span> &amp;&amp; localServletContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">		EmbeddedServletContainerFactory containerFactory = getEmbeddedServletContainerFactory();</span><br><span class="line">		<span class="comment">// 获取EmbeddedServletContainer</span></span><br><span class="line">		<span class="keyword">this</span>.embeddedServletContainer = containerFactory.getEmbeddedServletContainer(getSelfInitializer());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (localServletContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			getSelfInitializer().onStartup(localServletContext);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (ServletException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Cannot initialize servlet context"</span>,</span><br><span class="line">					ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	initPropertySources();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>6、可以看到<code>containerFactory.getEmbeddedServletContainer(getSelfInitializer());</code> 的参数<code>getSelfInitializer()</code>是个<code>ServletContextInitializer</code>对象</p>
</li>
<li><p><code>getSelfInitializer()</code>方法获得的<code>Servlet</code>初始化器内部会去构造一个<code>ServletContextInitializerBeans</code>(<code>Servlet</code>初始化器的集合)，<code>ServletContextInitializerBeans</code>构造的时候会去<code>Spring</code>容器中查找<code>ServletContextInitializer</code>类型的<code>bean</code>，其中<code>ServletRegistrationBean、FilterRegistrationBean、ServletListenerRegistrationBean</code>会被找出(如果有定义)，这3种<code>ServletContextInitializer</code>会在<code>onStartup</code>方法中将<code>Servlet、Filter、Listener</code>添加到<code>Servlet</code>容器中(如果我们只定义了<code>Servlet、Filter</code>或者<code>Listener，ServletContextInitializerBeans</code>内部会调用<code>addAdaptableBeans</code>方法把它们包装成<code>RegistrationBean</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> org.springframework.boot.web.servlet.<span class="function">ServletContextInitializer <span class="title">getSelfInitializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ServletContextInitializer() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">			selfInitialize(servletContext);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>7、进入<code>containerFactory.getEmbeddedServletContainer(getSelfInitializer());</code>继续跳入，就来到了<code>TomcatEmbeddedServletContainer.initialize();</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TomcatEmbeddedServletContainer</span><span class="params">(Tomcat tomcat, <span class="keyword">boolean</span> autoStart)</span> </span>&#123;</span><br><span class="line">	Assert.notNull(tomcat, <span class="string">"Tomcat Server must not be null"</span>);</span><br><span class="line">	<span class="keyword">this</span>.tomcat = tomcat;</span><br><span class="line">	<span class="keyword">this</span>.autoStart = autoStart;</span><br><span class="line">	<span class="comment">// 启动容器</span></span><br><span class="line">	initialize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> EmbeddedServletContainerException </span>&#123;</span><br><span class="line">       TomcatEmbeddedServletContainer.logger</span><br><span class="line">               .info(<span class="string">"Tomcat initialized with port(s): "</span> + getPortsDescription(<span class="keyword">false</span>));</span><br><span class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>.monitor) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               addInstanceIdToEngineName();</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="comment">// Remove service connectors to that protocol binding doesn't happen</span></span><br><span class="line">                   <span class="comment">// yet</span></span><br><span class="line">                   removeServiceConnectors();</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// Start the server to trigger initialization listeners</span></span><br><span class="line">                   <span class="comment">// 启动 Tomcat</span></span><br><span class="line">                   <span class="keyword">this</span>.tomcat.start();</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li><code>SpringBoot</code>内置了<code>Servlet</code>容器，这样项目的发布、部署就不需要额外的<code>Servlet</code>容器，直接启动<code>jar</code>包即可</li>
<li>如果是<code>Web</code>程序，那么会构造<code>AnnotationConfigEmbeddedWebApplicationContext</code>类型的<code>Spring</code>容器，<code>AnnotationConfigEmbeddedWebApplicationContext</code>类型的<code>Spring</code>容器在<code>refresh</code>的过程中会在<code>onRefresh</code>方法中创建内置的<code>Servlet</code>容器。</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>芋道源码 <a href="http://www.iocoder.cn" target="_blank" rel="noopener">http://www.iocoder.cn</a></li>
<li><a href="https://www.jianshu.com/p/043579ae733f" target="_blank" rel="noopener">https://www.jianshu.com/p/043579ae733f</a></li>
</ul>

        </div>

        <blockquote class="post-copyright">
    <footer>
        <a href="http://www.songshuiyang.com">
            <img src="/img/avatar.jpg" alt="songshuiyang">
            songshuiyang
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Boot/">Spring Boot</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.songshuiyang.com/2019/08/06/backend/framework/spring/spring-boot/analysis/SpringBoot(七)内嵌Tomcat启动原理解析/&title=《SpringBoot(七)内嵌Tomcat启动原理解析》 — 宋水阳个人博客&pic=http://www.songshuiyang.com/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.songshuiyang.com/2019/08/06/backend/framework/spring/spring-boot/analysis/SpringBoot(七)内嵌Tomcat启动原理解析/&title=《SpringBoot(七)内嵌Tomcat启动原理解析》 — 宋水阳个人博客&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.songshuiyang.com/2019/08/06/backend/framework/spring/spring-boot/analysis/SpringBoot(七)内嵌Tomcat启动原理解析/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《SpringBoot(七)内嵌Tomcat启动原理解析》 — 宋水阳个人博客&url=http://www.songshuiyang.com/2019/08/06/backend/framework/spring/spring-boot/analysis/SpringBoot(七)内嵌Tomcat启动原理解析/&via=http://www.songshuiyang.com" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.songshuiyang.com/2019/08/06/backend/framework/spring/spring-boot/analysis/SpringBoot(七)内嵌Tomcat启动原理解析/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2019/08/06/backend/framework/spring/spring-boot/analysis/SpringBoot(八)配置Mybatis多数据源/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">SpringBoot(八)配置Mybatis多数据源</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/08/06/backend/framework/spring/spring-boot/analysis/SpringBoot(六)Starter解析及自己定制实现/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">SpringBoot(六)Starter解析及自己定制实现</h4>
      </a>
    </div>
  
</nav>



    











    <!-- Valine Comments -->
    <div class="comments vcomment" id="comments"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
    <!-- Valine Comments script -->
    <script>
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
          return GUEST_INFO.indexOf(item) > -1
        });
        new Valine({
            el: '#comments',
            notify: 'false' == 'true',
            verify: 'false' == 'true',
            appId: "cOdgshzpM38eAScO4B50lpML-gzGzoHsz",
            appKey: "yNmbxCmHmD0IXElWkbpImpzl",
            avatar: "robohash",
            placeholder: "少侠不吐槽吐槽?",
            guest_info: guest_info.length == 0 ? GUEST_INFO : guest_info,
            pageSize: "10"
        })
    </script>
    <!-- Valine Comments end -->










</article>



</div>

        <footer class="footer">
    <div class="bottom">
        <p><span>songshuiyang &copy; 2017 - 2023</span>
            <span>
                
                <a href="http://beian.miit.gov.cn" target="_blank">赣ICP备18001541号</a><br>
                
            </span>
            <span id="busuanzi_container_site_pv">
                本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.songshuiyang.com/2019/08/06/backend/framework/spring/spring-boot/analysis/SpringBoot(七)内嵌Tomcat启动原理解析/&title=《SpringBoot(七)内嵌Tomcat启动原理解析》 — 宋水阳个人博客&pic=http://www.songshuiyang.com/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.songshuiyang.com/2019/08/06/backend/framework/spring/spring-boot/analysis/SpringBoot(七)内嵌Tomcat启动原理解析/&title=《SpringBoot(七)内嵌Tomcat启动原理解析》 — 宋水阳个人博客&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.songshuiyang.com/2019/08/06/backend/framework/spring/spring-boot/analysis/SpringBoot(七)内嵌Tomcat启动原理解析/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《SpringBoot(七)内嵌Tomcat启动原理解析》 — 宋水阳个人博客&url=http://www.songshuiyang.com/2019/08/06/backend/framework/spring/spring-boot/analysis/SpringBoot(七)内嵌Tomcat启动原理解析/&via=http://www.songshuiyang.com" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.songshuiyang.com/2019/08/06/backend/framework/spring/spring-boot/analysis/SpringBoot(七)内嵌Tomcat启动原理解析/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASYAAAEmCAAAAADqr2IGAAAEeklEQVR42u3aS27jSBAFQN//0p5tA2PJ72XSBosOrRpqmSwFBeT34yN+ff7zav/q/fuza/7/r/L32zt+YMKECROmw5k+376Sz7w/4qsrzM4wezD5qV7+IDBhwoQJ0+FMbdjOCfLYuk8yXp2qTUcwYcKECdNfZmoDapsWtA9jA4cJEyZMmDDtk4NZgzhv3bYPBhMmTJgw/U2m/eX2AThvLict3TyZuLgXjgkTJkyYbsbUtlaf9O8f2W/ChAkTJky3YfosX23xuV/ruTYpmb0wYcKECdO5THmAzDnapvBmxed9mdq+/01zGRMmTJgwPYIpD9vJ7fOGb9tsnY0z8+UhTJgwYcL0JKb8S256ngl3i7IaPcZLQpgwYcKE6VymWVCckc3mgz9xqvc/iy8+gwkTJkyYHsfUFpA5QdJmbe81C/bFoBQTJkyYMB3L1DY92wD8O9yz9nE+rMWECRMmTOcy5Y3dzTpOPTIsG815QpAvIQ3735gwYcKE6cZMyZ9tQu/+/TxZGRa374teTJgwYcJ0ONM+UWjbu5svucGt0wVMmDBhwnQs0+zGs+bvvhzdN5rzMSomTJgwYXoGUx7487DaHmXfJs7L+Bk9JkyYMGE6l6ld0NkXyfmQcjM6nT3+5L6YMGHChOksprb9eu1qzlVrQNc2pr+4AiZMmDBhOpZpONIbNXM3n89bups2cTHOxIQJEyZMhzBt1lyu/WQ7YmyTic0ZMGHChAnT6UyzDCLHnQX4WdqRPP58ueebDgEmTJgwYTqEKR/1tQVtHob3NO01iytgwoQJE6ZjmZIBYZIQtCVrG6Q3BXaeynzzeDBhwoQJ04FMeej9uf5ne/225N73dTFhwoQJ01OZ8mZom0zMEPNSNk87ov/FhAkTJkzHMrUBfjPsnI0/9wPOtti+IA/ChAkTJky3YfrN5/ATo8e8fbwhxoQJEyZMpzO1Y8VZyZqPKvePJxltFkNTTJgwYcJ0OFM+Pkxw84bp7GtfVUjnDwwTJkyYMJ3LtFl2aZOGfHHnqjHqVaU4JkyYMGE6lylv5rbpQk6c8+1P1T7UL5q8mDBhwoTpcUx5k3TWMk5aw7NMZ3MXTJgwYcL0DKYLguVoDNku08wayrMfwcviGRMmTJgwHcg0+6qzdc/9Wk9O0I5FvzknJkyYMGE6lqk9br3gUpbQbSM4YWqL6iJ7woQJEyZMt2fKFTdhOD9uuwBUV/mzISsmTJgwYXoEUx5uN//Oj7hJPpLzF4U0JkyYMGE6lmnfw9yE832oTq45u+PqQJgwYcKE6TZMs5WXZIEmh2uHmi1Hfq+XPwJMmDBhwnQs0ywm5p9p0a9KKTbl+iZxwYQJEyZM92TKG6NJmJ+t+OTt3VmxvUlKMGHChAnTM5jef6XZ2s0mvUg+uRl81oU0JkyYMGH6M0x5O7itvxP0tjU8W83BhAkTJkyY2sJ4UzbPyvJNO/iLK2DChAkTpsOZ9o3Rq1KHvPk7u1dy/VUvHBMmTJgw3YypbXrmoO11fjNFuGCbCRMmTJgw3Z3pP6UKjK2hd/saAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


lazyScripts.push('//s95.cnzz.com/z_stat.php?id=1275444015&web_id=1275444015')

</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '老铁为何离开了';
            clearTimeout(titleTime);
        } else {
            document.title = '欢迎回来';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ac93934d9b847216e10a2f133187e535";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>
